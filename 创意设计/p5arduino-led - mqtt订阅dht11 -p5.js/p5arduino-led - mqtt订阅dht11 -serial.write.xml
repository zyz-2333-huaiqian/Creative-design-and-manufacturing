<xml xmlns="http://www.w3.org/1999/xhtml"><block type="base_setup" id="NoD!FpflegZH3vU;ot0w" x="-12" y="13"><comment pinned="false" h="80" w="160">第四步：初始化</comment><statement name="DO"><block type="serial_begin" id="+TCMZ{f0%K}`,HVG!}9)"><field name="serial_select">Serial</field><value name="CONTENT"><shadow type="math_number" id="YHP$lf!@p-+n4I+fWZZ7"><field name="NUM">9600</field></shadow></value><next><block type="wifi_begin_esp8266" id="X:dUK@]4;NRCLRWRVl:t"><value name="wifi_name"><block type="text" id="LznX}#@qL{|^3cf[:g;p"><field name="TEXT">hh</field></block></value><value name="wifi_pwd"><block type="text" id="rV]0/Q$0_]/q+TJ)*XY0"><field name="TEXT">12345678</field></block></value><next><block type="client" id="E!5R+~qvyySC.)3U?{JT"><next><block type="controls_whileUntil" id="=GaC-pO]|,`SV/eehm@2"><field name="MODE">WHILE</field><comment pinned="false" h="80" w="160">第一步：连接WiFi</comment><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="wifi_fail_connect" id="Hub,z[[n$x(z?m*u1#J("></block></value><statement name="DO"><block type="controls_delay" id="=xA1YZ.^ryX(9M@^bnj!"><field name="UNIT">delay</field><value name="DELAY_TIME"><shadow type="math_number" id="Y(U)ALwj:RVKI,m~[L@f"><field name="NUM">500</field></shadow></value><next><block type="serial_print" id="-H7~09pw7u(l@z[n9@%^"><field name="serial_select">Serial</field><field name="new_line">print</field><value name="CONTENT"><block type="text_char" id="d2xten7z7O4O;/eL77h@"><field name="TEXT">.</field></block></value></block></next></block></statement><next><block type="makePubSubClientObject" id="HM9xfaZAK6/DLQq`r7PS"><next><block type="variables_declare" id="|11s;NA$19=w${4Upa=_"><field name="variables_type">global_variate</field><field name="VAR">mqttServer</field><field name="TYPE">char*</field><value name="VALUE"><block type="text" id="x|qOi{IA*+v3~q[(uu#|"><field name="TEXT">test.ranye-iot.net</field></block></value><next><block type="setMqttServerBroker" id="8M5_;#eik16!uT1U0noH"><value name="mqttServerBrokerIP"><block type="variables_get" id="//aqhJ|gBfN56$i^o[{J"><field name="VAR">mqttServer</field></block></value><value name="mqttServerBrokerPort"><block type="math_number" id="WZk|Qc$tiX3ApH2{n!C}"><field name="NUM">1883</field></block></value><next><block type="procedures_callnoreturn" id="rL5J|iPGvSQ%zjr+gQnj"><mutation name="connectMQTTServer"></mutation><next><block type="procedures_callnoreturn" id="`)BK8)gJP(wuQ{j!tpsT"><mutation name="subscribeTopic"><arg name="subTopicString"></arg></mutation><value name="ARG0"><block type="text" id="oi?kY[uo:u/@X=rmXD1S"><field name="TEXT">andy/sensor/#</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type="procedures_defnoreturn" id="gE.iyure^)PT1jTnZ)g{" collapsed="true" x="712" y="287"><field name="NAME">connectMQTTServer</field><comment pinned="false" h="80" w="160">第二步：定义连接到MQTT服务器函数</comment><statement name="STACK"><block type="variables_declare" id=".MZSw+ji^(2(%SsU?8oR"><field name="variables_type">local_variate</field><field name="VAR">clientId</field><field name="TYPE">String</field><value name="VALUE"><block type="text_join" id="y5)GRG6xP6FB~`_WKbe%"><value name="A"><shadow type="text" id="PAwi}#b1(7Lh7B%mXFfx"><field name="TEXT">esp8266-</field></shadow></value><value name="B"><shadow type="text"><field name="TEXT">Mixly</field></shadow><block type="getWiFiMacAddress" id="BjhQ,McrD73hxC3pG5~;"></block></value></block></value><next><block type="controls_if" id="a(s3*NEP+kTRAm3trp@1"><mutation else="1"></mutation><value name="IF0"><block type="mqttClientIsConnectedOK" id="TZ3=SvOK[ekNIKa~!}-0"><value name="clientId"><shadow type="text"><field name="TEXT">字符数组</field></shadow><block type="turn_stringObject_to_charArray" id="4V1opDLcJ@y0Z{=AZfcV"><value name="stringObjectSource"><shadow type="text"><field name="TEXT">hello</field></shadow><block type="variables_get" id="lhwb08e7dKu1@%nxD^?)"><field name="VAR">clientId</field></block></value></block></value></block></value><statement name="DO0"><block type="serial_println" id="p=@k16Hr5!cAoWadPb3e"><field name="serial_select">Serial</field><field name="new_line">println</field><value name="CONTENT"><block type="text" id="pOCt-O^[3=igAv*u0G6!"><field name="TEXT">MQTT Server Connected.</field></block></value><next><block type="serial_println" id="J(akS24pZ+Ye*dP;5PRT"><field name="serial_select">Serial</field><field name="new_line">print</field><value name="CONTENT"><block type="text" id="(gnmQoSw?-(ul9F;rp!_"><field name="TEXT">Server Address: </field></block></value><next><block type="serial_println" id="UVlF|}ELFJ5d0!|4=j00"><field name="serial_select">Serial</field><field name="new_line">println</field><value name="CONTENT"><block type="variables_get" id="e,d-1EniYiuli7?([Lpy"><field name="VAR">mqttServer</field></block></value><next><block type="serial_println" id="qr6IP1_fOp_+!;?:q.Cz"><field name="serial_select">Serial</field><field name="new_line">print</field><value name="CONTENT"><block type="text" id="o2j{xb$TL6RC2-aeg$sk"><field name="TEXT">ClientId: </field></block></value><next><block type="serial_println" id="1,)=g^RF4pV5.1|We|1t"><field name="serial_select">Serial</field><field name="new_line">println</field><value name="CONTENT"><block type="variables_get" id="Ox2YHw}c_`ix0C,:9RRi"><field name="VAR">clientId</field></block></value></block></next></block></next></block></next></block></next></block></statement><statement name="ELSE"><block type="serial_println" id="ep.bn|[zW0A`wp)1-_Ma"><field name="serial_select">Serial</field><field name="new_line">print</field><value name="CONTENT"><block type="text" id="se)TzgU+EfqYwuITuQ5B"><field name="TEXT">MQTT Server Connect Failed. Client State:</field></block></value><next><block type="serial_println" id="(ZAk6w}.7xoZTDJkMvz2"><field name="serial_select">Serial</field><field name="new_line">println</field><value name="CONTENT"><block type="getmqttClientStatus" id="C3nB4,cvNV_[Cq?{*_fd"></block></value><next><block type="controls_delay" id="00!-Ugv4|E?jcLd0^ah|"><field name="UNIT">delay</field><value name="DELAY_TIME"><shadow type="math_number" id="Hd*TD$oSZ5V?G4ttw4C*"><field name="NUM">3000</field></shadow></value></block></next></block></next></block></statement></block></next></block></statement></block><block type="procedures_defnoreturn" id="`HaS-hFC6z?%8Z$9J}e2" x="687" y="487"><mutation><arg name="subTopicString" vartype="String"></arg></mutation><field name="NAME">subscribeTopic</field><comment pinned="false" h="80" w="160">第三步：定义订阅函数</comment><statement name="STACK"><block type="variables_declare" id="KPJ@ef.zcvzw@a8(At)c"><field name="variables_type">local_variate</field><field name="VAR">topicString</field><field name="TYPE">String</field><value name="VALUE"><block type="variables_get" id="z-*fo$^K6k;|_pyg#X$L"><field name="VAR">subTopicString</field></block></value><next><block type="declareCharArray" id="LwwJ~O/2LdLh5u3[N_+H"><field name="charArrayName">subTopic</field><value name="charArrayLength"><shadow type="math_number"><field name="NUM">100</field></shadow><block type="get_stringObject_length" id="IIBdj8RvNyIkYy/kbRjI"><value name="stringObject"><shadow type="text"><field name="TEXT">messageString</field></shadow><block type="variables_get" id="GjzcR(oJf@3YgPq0wLFB"><field name="VAR">topicString</field></block></value></block></value><next><block type="copy_stringObject_to_charArray" id="HZG2yuFCv/|laThjT$jb"><field name="to_charArray">subTopic</field><value name="stringObject_from"><shadow type="turn_stringObject_to_charArray"><value name="stringObjectSource"><shadow type="text"><field name="TEXT">hello</field></shadow></value></shadow><block type="turn_stringObject_to_charArray" id="GMY;C+i1nugeJJ~DdIeh"><value name="stringObjectSource"><shadow type="text"><field name="TEXT">hello</field></shadow><block type="variables_get" id="OO{z/I(2xBO$eqPh3*S."><field name="VAR">topicString</field></block></value></block></value><next><block type="controls_if" id="E9dFZj,v=-_q8g.ER).k"><mutation else="1"></mutation><value name="IF0"><block type="mqttSubOK" id="+~:QZ..gey}|BNXPr!fK"><value name="mqttSubTopic"><shadow type="text"><field name="TEXT">topic</field></shadow><block type="variables_get" id="A|X5o3j!*:)TaeF~V.Cw"><field name="VAR">subTopic</field></block></value></block></value><statement name="DO0"><block type="serial_println" id="n5Ib[UOr@@!+hMUZnW}N"><field name="serial_select">Serial</field><field name="new_line">println</field><value name="CONTENT"><block type="text" id="]EP_e]|7%)0FCE6p9%JU"><field name="TEXT">Subscrib Topic:</field></block></value><next><block type="serial_println" id="faI^5;2E/HUP31o2)8{F"><field name="serial_select">Serial</field><field name="new_line">println</field><value name="CONTENT"><block type="variables_get" id="I:OLDcLzN*~!W@}%.6kx"><field name="VAR">subTopic</field></block></value></block></next></block></statement><statement name="ELSE"><block type="serial_println" id="JCiXe,D=4ki_8()kch#("><field name="serial_select">Serial</field><field name="new_line">print</field><value name="CONTENT"><block type="text" id="paVka=cOEQ]:ZFm5uP**"><field name="TEXT">Subscribe Fail...</field></block></value></block></statement></block></next></block></next></block></next></block></statement></block><block type="controls_if" id="r+]ZPQ_vhGF{@WBax_-[" x="-12" y="564"><mutation else="1"></mutation><comment pinned="false" h="80" w="160">第五步：死循环，保持心跳</comment><value name="IF0"><block type="mqttClientIsConnected" id="~l1an%.$9,%Zl)o+tz59"></block></value><statement name="DO0"><block type="mqttClientKeepAlive" id="M@pCu(Org3J?U`%QkZ]t"></block></statement><statement name="ELSE"><block type="procedures_callnoreturn" id="GiXBS*`6$(~w/uSkPfF!"><mutation name="connectMQTTServer"></mutation></block></statement><next><block type="mqtt_callback_func" id="HK:/IETb[(9Xj5)-$Fs;"><field name="funcName">receiveCallback</field><statement name="func_body"><block type="controls_for" id="K[v*)Gu:ixb)`QvBIhcw"><field name="VAR">i</field><value name="FROM"><shadow type="math_number" id="ubNY#h$;HRY%p/i|j3n["><field name="NUM">1</field></shadow></value><value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow><block type="variables_get" id="1f__b,eQ08qSr@h4@@^6"><field name="VAR">length</field></block></value><value name="STEP"><shadow type="math_number" id="-oW$9)84;snnH%TeKZ|3"><field name="NUM">1</field></shadow></value><statement name="DO"><block type="serial_write" id="bCr[=2v35tSvTM3Z~|K5"><field name="serial_select">Serial</field><value name="CONTENT"><block type="type_conversion" id="GnFV%ybK?kPdiA%NuZF7"><field name="type">char</field><value name="variable"><shadow type="text"><field name="TEXT">payload</field></shadow><block type="lists_getIndex" id="l}=~$aaW^7%gZGsjoA|e"><field name="VAR">payload</field><value name="AT"><shadow type="math_number"><field name="NUM">1</field></shadow><block type="variables_get" id="yhOB^H?`g=x/.xy}g,d_"><field name="VAR">i</field></block></value></block></value></block></value></block></statement></block></statement><next><block type="MQTT_SUB_Callback" id="ro%C1!Atccg:n46SZCL6"></block></next></block></next></block></xml>